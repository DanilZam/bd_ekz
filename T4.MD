-- Table: Владелец
CREATE TABLE Владелец (
    КодВладельца INT PRIMARY KEY IDENTITY(1,1),
    ФИО VARCHAR(100) NOT NULL,
    Адрес VARCHAR(100) NOT NULL,
    Телефон VARCHAR(15) NOT NULL
);


-- Table: Лошади
CREATE TABLE Лошади (
    КодЛошади INT PRIMARY KEY IDENTITY(1,1),
    Кличка VARCHAR(50) NOT NULL,
    Пол CHAR(1) CHECK (Пол IN ('М', 'Ж')) NOT NULL,
    Возраст INT NOT NULL,
    КодВладельца INT NOT NULL,
    FOREIGN KEY (КодВладельца) REFERENCES Владелец(КодВладельца)
);


-- Table: Жокеи
CREATE TABLE Жокеи (
    КодЖокея INT PRIMARY KEY IDENTITY(1,1),
    ФИО VARCHAR(100) NOT NULL,
    Возраст INT NOT NULL,
    Рейтинг DECIMAL(3, 2) CHECK (Рейтинг >= 0 AND Рейтинг <= 10) NOT NULL
);


-- Table: Ипподром
CREATE TABLE Ипподром (
    КодИпподрома INT PRIMARY KEY IDENTITY(1,1),
    НазваниеИпподрома VARCHAR(100) DEFAULT('Неизвестное название') NOT NULL,
    АдресИпподрома VARCHAR(100) NOT NULL
);


-- Table: Состязания
CREATE TABLE Состязания (
    КодСостязания INT PRIMARY KEY IDENTITY(1,1),
    ДатаВремяНачала DATETIME NOT NULL,
    ДатаВремяОкончания DATETIME NOT NULL,
    КодИпподрома INT NOT NULL,
    FOREIGN KEY (КодИпподрома) REFERENCES Ипподром(КодИпподрома)
);


-- Table: Заезды
CREATE TABLE Заезды (
    КодЗаезда INT PRIMARY KEY IDENTITY(1,1),
    КодСостязания INT NOT NULL,
    НомерЗаездаВСостязании INT NOT NULL,
    FOREIGN KEY (КодСостязания) REFERENCES Состязания(КодСостязания)
);


-- Table: УчастникиЗаезда
CREATE TABLE УчастникиЗаезда (
    НомерУчастника INT PRIMARY KEY IDENTITY(1,1),
    КодЛошади INT NOT NULL,
    КодЖокея INT NOT NULL,
    КодЗаезда INT NOT NULL,
    ЗанятоеМесто INT NOT NULL,
    ВремяНачалаЗаезда DATETIME NOT NULL,
    ВремяОкончанияЗаезда DATETIME NOT NULL,
    FOREIGN KEY (КодЛошади) REFERENCES Лошади(КодЛошади),
    FOREIGN KEY (КодЖокея) REFERENCES Жокеи(КодЖокея),
    FOREIGN KEY (КодЗаезда) REFERENCES Заезды(КодЗаезда)
);



-- Вставка данных в таблицу Владелец
INSERT INTO Владелец (ФИО, Адрес, Телефон) VALUES 
('Иванов Иван Иванович', 'ул. Пушкина, д. 10', '123-456-7890'),
('Петров Петр Петрович', 'ул. Лермонтова, д. 5', '987-654-3210');

-- Вставка данных в таблицу Лошади
INSERT INTO Лошади (Кличка, Пол, Возраст, КодВладельца) VALUES 
('Спринтер', 'М', 5, 1),
('Грация', 'Ж', 4, 2),
('Торнадо_л', 'М', 6, 1);

-- Вставка данных в таблицу Жокеи
INSERT INTO Жокеи (ФИО, Возраст, Рейтинг) VALUES 
('Сидоров Алексей Иванович', 28, 8.5),
('Козлов Игорь Петрович', 35, 7),
('Павлов Дмитрий Сергеевич', 30, 9.2);

-- Вставка данных в таблицу Ипподром
INSERT INTO Ипподром (НазваниеИпподрома, АдресИпподрома) VALUES 
('Центральный ипподром', 'ул. Кирова, д. 15'),
('Звездный ипподром', 'пр. Ленина, д. 20');

-- Вставка данных в таблицу Состязания
INSERT INTO Состязания (ДатаВремяНачала, ДатаВремяОкончания, КодИпподрома) VALUES 
('2024-06-10 14:00:00', '2024-06-10 17:00:00', 1),
('2024-07-05 13:30:00', '2024-07-05 16:30:00', 2);

-- Вставка данных в таблицу Заезды
INSERT INTO Заезды (КодСостязания, НомерЗаездаВСостязании) VALUES 
(1, 1),
(1, 2),
(2, 1),
(2, 2);

-- Вставка данных в таблицу УчастникиЗаезда
INSERT INTO УчастникиЗаезда (КодЛошади, КодЖокея, КодЗаезда, ЗанятоеМесто, ВремяНачалаЗаезда, ВремяОкончанияЗаезда) VALUES 
(1, 1, 1, 2, '2024-06-10 14:05:00', '2024-06-10 14:25:00'),
(2, 2, 1, 1, '2024-06-10 14:10:00', '2024-06-10 14:30:00'),
(3, 3, 1, 3, '2024-06-10 14:15:00', '2024-06-10 14:35:00'),
(1, 1, 2, 1, '2024-06-10 14:45:00', '2024-06-10 15:05:00'),
(2, 2, 2, 2, '2024-06-10 14:50:00', '2024-06-10 15:10:00'),
(3, 3, 2, 3, '2024-06-10 14:55:00', '2024-06-10 15:15:00'),
(1, 1, 3, 3, '2024-07-05 13:40:00', '2024-07-05 14:00:00'),
(2, 2, 3, 2, '2024-07-05 13:45:00', '2024-07-05 14:05:00'),
(3, 3, 3, 1, '2024-07-05 13:50:00', '2024-07-05 14:10:00'),
(1, 1, 4, 2, '2024-07-05 14:15:00', '2024-07-05 14:35:00'),
(2, 2, 4, 1, '2024-07-05 14:20:00', '2024-07-05 14:40:00'),
(3, 3, 4, 3, '2024-07-05 14:25:00', '2024-07-05 14:45:00');




Задание 1

Задание 2

CREATE PROCEDURE ПолучитьИнформациюОСкакунах
AS
BEGIN
    SELECT Лошади.*
    FROM Лошади
    WHERE Кличка LIKE '%о\_л%' ESCAPE '\';
END;

EXEC ПолучитьИнформациюОСкакунах

Задание 3

CREATE PROCEDURE ПолучитьФИОВладельца
    @КодВладельца INT,
    @ФИО VARCHAR(100) OUTPUT
AS
BEGIN
    SELECT @ФИО = ФИО
    FROM Владелец
    WHERE КодВладельца = @КодВладельца;
END;

DECLARE
    @КодВладельца INT = 1,
    @ФИО VARCHAR(100);

EXEC ПолучитьФИОВладельца @КодВладельца, @ФИО OUTPUT;

SELECT @ФИО AS ФИО;

Задание 4

CREATE TRIGGER УдалитьДанныеПоВладельцу
ON Владелец
INSTEAD OF DELETE
AS
BEGIN
    DECLARE @КодВладельца INT;
    SELECT @КодВладельца = КодВладельца FROM deleted;


    DELETE FROM УчастникиЗаезда
    WHERE КодЛошади IN (SELECT КодЛошади FROM Лошади WHERE КодВладельца = @КодВладельца);

    DELETE FROM Лошади
    WHERE КодВладельца = @КодВладельца;

	DELETE FROM Владелец
    WHERE КодВладельца = @КодВладельца;
END;


SELECT * FROM Владелец
SELECT * FROM Лошади
SELECT * FROM УчастникиЗаезда

DELETE FROM Владелец WHERE КодВладельца = 1

SELECT * FROM Владелец
SELECT * FROM Лошади
SELECT * FROM УчастникиЗаезда


Задание 5

CREATE VIEW СведенияОСкачках AS
SELECT 
    Состязания.КодСостязания,
    Состязания.ДатаВремяНачала AS ВремяНачала,
    Состязания.ДатаВремяОкончания AS ВремяОкончания,
    Ипподром.НазваниеИпподрома AS Ипподром
FROM 
    Состязания
JOIN 
    Ипподром ON Состязания.КодИпподрома = Ипподром.КодИпподрома
ORDER BY 
    ВремяНачала DESC
OFFSET 0 ROWS;

SELECT * FROM СведенияОСкачках


Задание 6

SELECT 
    Л.Кличка AS Кличка,
    Л.Возраст AS Возраст,
    В.ФИО AS Владелец,
    COUNT(У.КодЗаезда) AS ЧислоСкачек
FROM 
    Лошади Л
JOIN 
    Владелец В ON Л.КодВладельца = В.КодВладельца
LEFT JOIN 
    УчастникиЗаезда У ON Л.КодЛошади = У.КодЛошади
GROUP BY 
    Л.Кличка, Л.Возраст, В.ФИО
ORDER BY 
    Кличка DESC;


Задание 7

SELECT *
FROM Лошади
WHERE Лошади.КодЛошади != 1
AND Лошади.КодЛошади NOT IN (
	SELECT Лошади.КодЛошади
	FROM Лошади
	INNER JOIN УчастникиЗаезда ON УчастникиЗаезда.КодЛошади = Лошади.КодЛошади
	INNER JOIN Заезды ON Заезды.КодЗаезда = УчастникиЗаезда.КодЗаезда
	INNER JOIN Состязания ON Состязания.КодСостязания = Заезды.КодСостязания
	WHERE Состязания.КодСостязания NOT IN (
		SELECT Состязания.КодСостязания
		FROM Состязания
		INNER JOIN Заезды ON Заезды.КодСостязания = Состязания.КодСостязания
		INNER JOIN УчастникиЗаезда ON УчастникиЗаезда.КодЗаезда = Заезды.КодЗаезда
		INNER JOIN Лошади ON Лошади.КодЛошади = УчастникиЗаезда.КодЛошади
		WHERE Лошади.КодЛошади = 1
	)
);
