Задача 1 new ver.

CREATE TABLE Пациенты (
    КодПациента INT PRIMARY KEY IDENTITY(1,1),
    ФИО VARCHAR(120) NOT NULL,
    Пол CHAR(1) CHECK (Пол IN ('М','Ж'))  NOT NULL,
    ДатаРождения DATE NOT NULL,
    ДомашнийАдрес VARCHAR(255) NOT NULL
);




CREATE TABLE КатегорияВрача (
    КодКатегории INT PRIMARY KEY IDENTITY(1,1),
    НаименованиеКатегории VARCHAR(100) NOT NULL
);




CREATE TABLE Врачи (
    КодВрача INT PRIMARY KEY IDENTITY(1,1),
    ФИО VARCHAR(120) NOT NULL,
    КодКатегории INT NOT NULL
);




USE Поликлиника
ALTER TABLE Врачи ADD CONSTRAINT FK_Сотрудники_Должности FOREIGN KEY(КодКатегории) REFERENCES КатегорияВрача(КодКатегории);




CREATE TABLE Предписания (
    КодПредписания INT PRIMARY KEY IDENTITY(1,1),
    ОписаниеПредписания VARCHAR(255) NOT NULL
);




CREATE TABLE ЛекарственныеСредства (
    КодЛекарства INT PRIMARY KEY IDENTITY(1,1),
    Название VARCHAR(100) NOT NULL,
    Дозировка VARCHAR(100) NOT NULL
);




CREATE TABLE Симптомы (
    КодСимптома INT PRIMARY KEY IDENTITY(1,1),
    ОписаниеСимптома VARCHAR(255) NOT NULL
);




CREATE TABLE Диагнозы (
    КодДиагноза INT PRIMARY KEY IDENTITY(1,1),
    НазваниеДиагноза VARCHAR(255) NOT NULL
);




USE Поликлиника
CREATE TABLE Приемы (
    КодПриема INT PRIMARY KEY IDENTITY(1,1),
    КодПациента INT NOT NULL,
    КодВрача INT NOT NULL,
    ДатаНачала DATETIME NOT NULL,
    ДатаОкончания DATETIME NOT NULL,
    МестоОсмотра VARCHAR(11) NOT NULL DEFAULT 'Поликлиника',
    CONSTRAINT FK_Приемы_Пациенты FOREIGN KEY (КодПациента) REFERENCES Пациенты(КодПациента) ON DELETE CASCADE,
    CONSTRAINT FK_Приемы_Врачи FOREIGN KEY (КодВрача) REFERENCES Врачи(КодВрача),
    CONSTRAINT CK_Приемы_МестоОсмотра  CHECK (МестоОсмотра IN ('Поликлиника', 'На дому'))
);




USE Поликлиника
CREATE TABLE СимптомыДиагноза (
    КодДиагноза INT NOT NULL,
    КодСимптома INT NOT NULL,
    CONSTRAINT FK_СимптомыДиагноза_Диагнозы FOREIGN KEY (КодДиагноза) REFERENCES Диагнозы(КодДиагноза),
    CONSTRAINT FK_СимптомыДиагноза_Симптомы FOREIGN KEY (КодСимптома) REFERENCES Симптомы(КодСимптома),
);




USE Поликлиника
CREATE TABLE ПоставленныеДиагнозы (
    КодДиагноза INT NOT NULL,
    КодПриема INT NOT NULL,
    CONSTRAINT FK_ПоставленныеДиагнозы_Диагнозы FOREIGN KEY (КодДиагноза) REFERENCES Диагнозы(КодДиагноза),
    CONSTRAINT FK_ПоставленныеДиагнозы_Приемы FOREIGN KEY (КодПриема) REFERENCES Приемы(КодПриема),
);




USE Поликлиника
CREATE TABLE ПредписанияПациенту (
    КодПредписания INT NOT NULL,
    КодПриема INT NOT NULL,
    CONSTRAINT FK_ПредписанияПациенту_Предписания FOREIGN KEY (КодПредписания) REFERENCES Предписания(КодПредписания),
    CONSTRAINT FK_ПредписанияПациенту_Приемы FOREIGN KEY (КодПриема) REFERENCES Приемы(КодПриема)
);




USE Поликлиника
CREATE TABLE ВыписанныеЛекарства (
    КодЛекарства INT NOT NULL,
    КодПриема INT NOT NULL,
    CONSTRAINT FK_ВыписанныеЛекарства_ЛекарственныеСредства FOREIGN KEY (КодЛекарства) REFERENCES ЛекарственныеСредства(КодЛекарства),
    CONSTRAINT FK_ВыписанныеЛекарства_Приемы FOREIGN KEY (КодПриема) REFERENCES Приемы(КодПриема),
);






INSERT INTO ЛекарственныеСредства (Название, Дозировка) VALUES
('Парацетамол', '500мг'),
('Ибупрофен', '200мг'),
('Амоксициллин (концентрация 10%)', '250мг'),
('Цефтриаксон', '1г'),
('Метформин (концентрация 10%)', '850мг'),
('Лизиноприл (концентрация 20%)', '10мг'),
('Аспирин', '100мг'),
('Омепразол', '20мг'),
('Симвастатин (концентрация 33%)', '40мг'),
('Фуросемид', '40мг');




INSERT INTO КатегорияВрача (НаименованиеКатегории) VALUES
('Терапевт'),
('Хирург'),
('Кардиолог'),
('Педиатр'),
('Невролог');




INSERT INTO Врачи (ФИО, КодКатегории) VALUES
('Иванов Иван Иванович', 1),
('Петров Петр Петрович', 2),
('Сидоров Сидор Сидорович', 3),
('Кузнецова Анна Сергеевна', 4),
('Васильев Николай Николаевич', 5);




INSERT INTO Пациенты (ФИО, Пол, ДатаРождения, ДомашнийАдрес) VALUES
('Смирнова Мария Ивановна', 'Ж', '1985-03-22', 'ул. Ленина, д. 5, кв. 12'),
('Кузнецов Алексей Петрович', 'М', '1978-07-15', 'ул. Пушкина, д. 10, кв. 34'),
('Попова Наталья Сергеевна', 'Ж', '1992-11-30', 'ул. Горького, д. 15, кв. 56'),
('Соколов Михаил Анатольевич', 'М', '2000-05-18', 'ул. Чехова, д. 2, кв. 78'),
('Лебедева Ольга Владимировна', 'Ж', '1988-12-25', 'ул. Тихая, д. 8, кв. 90');




INSERT INTO Диагнозы (НазваниеДиагноза) VALUES
('Грипп'),
('Ангина'),
('Гастрит'),
('Гипертония'),
('Сахарный диабет');




INSERT INTO Симптомы (ОписаниеСимптома) VALUES
('Высокая температура'),
('Боль в горле'),
('Тошнота'),
('Головная боль'),
('Повышенное давление');




INSERT INTO Приемы (КодПациента, КодВрача, ДатаНачала, ДатаОкончания, МестоОсмотра) VALUES
(1, 1, '2024-05-20 10:00', '2024-05-20 10:30', 'Поликлиника'),
(2, 2, '2024-05-21 11:00', '2024-05-21 11:30', 'Поликлиника'),
(3, 3, '2024-05-22 12:00', '2024-05-22 12:30', 'Поликлиника'),
(4, 4, '2024-05-23 09:00', '2024-05-23 09:30', 'Поликлиника'),
(5, 5, '2024-05-24 14:00', '2024-05-24 14:30', 'Поликлиника');




INSERT INTO ПоставленныеДиагнозы (КодДиагноза, КодПриема) VALUES
(1, 1),
(2, 2),
(3, 3),
(4, 4),
(5, 5);




INSERT INTO СимптомыДиагноза (КодДиагноза, КодСимптома) VALUES
(1, 1),
(2, 2),
(3, 3),
(4, 4),
(5, 5);




INSERT INTO Предписания (ОписаниеПредписания) VALUES
('Постельный режим'),
('Полоскание горла'),
('Диета'),
('Прием лекарств'),
('Инъекции инсулина');




INSERT INTO ПредписанияПациенту (КодПредписания, КодПриема) VALUES
(1, 1),
(2, 2),
(3, 3),
(4, 4),
(5, 5);




INSERT INTO ВыписанныеЛекарства (КодЛекарства, КодПриема) VALUES
(1, 1),
(2, 2),
(3, 3),
(4, 4),
(5, 5);



Задание 1


Задание 2
CREATE OR ALTER PROCEDURE ЛекиПоКонцентрации
    @Concentration VARCHAR(3)
AS
BEGIN
    SELECT КодЛекарства, Название, Дозировка
    FROM ЛекарственныеСредства
    WHERE Название LIKE '%концентрация ' + @Concentration + '\%%' ESCAPE '\';
END;




EXEC ЛекиПоКонцентрации '10'



Задание 3
CREATE PROCEDURE ПолучитьИнформациюОВраче
    @КодВрача INT,
    @ФИО VARCHAR(120) OUTPUT,
    @НаименованиеКатегории VARCHAR(100) OUTPUT
AS
BEGIN
    SELECT
        @ФИО = Врачи.ФИО,
        @НаименованиеКатегории = КатегорииВрачей.НаименованиеКатегории
    FROM
        Врачи
    INNER JOIN
        Должности ON Врачи.КодКатегории = КатегорииВрачей.КодКатегории
    WHERE
        Врачи.КодВрача = @КодВрача;
END
GO




DECLARE @ФИО VARCHAR(120);
DECLARE @НаименованиеКатегории VARCHAR(100);




EXEC ПолучитьИнформациюОВраче 1,
    @ФИО = @ФИО OUTPUT,
    @НаименованиеКатегории = @НаименованиеКатегории OUTPUT;




SELECT @ФИО AS ФИО, @НаименованиеКатегории AS НаименованиеКатегории;


Задание 4
CREATE TRIGGER УдалениеСведенийОПациенте
ON Пациенты
INSTEAD OF DELETE
AS
BEGIN
	DECLARE @КодПациента INT;
    SELECT @КодПациента = КодПациента FROM deleted;


	DELETE FROM ВыписанныеЛекарства
    WHERE КодПриема IN (SELECT КодПриема FROM Приемы WHERE КодПациента = @КодПациента);




    DELETE FROM ПоставленныеДиагнозы
    WHERE КодПриема IN (SELECT КодПриема FROM Приемы WHERE КодПациента = @КодПациента);




    DELETE FROM ПредписанияПациенту
    WHERE КодПриема IN (SELECT КодПриема FROM Приемы WHERE КодПациента = @КодПациента);


	
    DELETE FROM Приемы
    WHERE КодПациента = @КодПациента;


	DELETE FROM Пациенты
    WHERE КодПациента = @КодПациента;
END
GO




SELECT * FROM Пациенты
SELECT * FROM Приемы
SELECT * FROM ВыписанныеЛекарства
SELECT * FROM ПредписанияПациенту
SELECT * FROM ПоставленныеДиагнозы




DELETE FROM Пациенты WHERE КодПациента = 2




SELECT * FROM Пациенты
SELECT * FROM Приемы
SELECT * FROM ВыписанныеЛекарства
SELECT * FROM ПредписанияПациенту
SELECT * FROM ПоставленныеДиагнозы


Задание 5
CREATE VIEW ПациентыДиагнозы AS
SELECT
    П.КодПациента,
    П.ФИО,
    П.Пол,
    П.ДатаРождения,
    П.ДомашнийАдрес,
    Д.КодДиагноза,
    Д.НазваниеДиагноза
FROM
    Пациенты П
INNER JOIN
    Приемы Пр ON П.КодПациента = Пр.КодПациента
INNER JOIN
    ПоставленныеДиагнозы ПД ON Пр.КодПриема = ПД.КодПриема
INNER JOIN
    Диагнозы Д ON ПД.КодДиагноза = Д.КодДиагноза
ORDER BY
    П.ФИО DESC
OFFSET 0 ROWS;
GO




SELECT * FROM ПациентыДиагнозы

Задание 6
SELECT
    Сотрудники.КодВрача,
    Сотрудники.ФИО AS Врач,
    AVG(DATEDIFF(minute, Приемы.ДатаНачала, Приемы.ДатаОкончания)) AS СреднееВремяПриема_в_минутах
FROM
    Сотрудники
INNER JOIN
    Приемы ON Сотрудники.КодВрача = Приемы.КодВрача
GROUP BY
    Сотрудники.КодВрача, Сотрудники.ФИО
ORDER BY
    СреднееВремяПриема_в_минутах DESC;


Задание 7
SELECT DISTINCT Пациенты.*
FROM ПоставленныеДиагнозы
INNER JOIN Приемы ON Приемы.КодПриема = ПоставленныеДиагнозы.КодПриема
INNER JOIN Пациенты ON Пациенты.КодПациента = Приемы.КодПациента
WHERE
ПоставленныеДиагнозы.КодДиагноза IN (
    SELECT ПоставленныеДиагнозы.КодДиагноза
    FROM ПоставленныеДиагнозы
    INNER JOIN Приемы ON Приемы.КодПриема = ПоставленныеДиагнозы.КодПриема
    INNER JOIN Пациенты ON Пациенты.КодПациента = Приемы.КодПациента
    WHERE Пациенты.ФИО = 'Иванов Иван Иванович'
)
AND
Пациенты.ФИО != 'Иванов Иван Иванович'
GROUP BY Пациенты.КодПациента, Пациенты.ФИО, Пациенты.Пол, Пациенты.ДомашнийАдрес, Пациенты.ДатаРождения
HAVING COUNT(DISTINCT КодДиагноза) = (
    SELECT COUNT(DISTINCT КодДиагноза)
    FROM ПоставленныеДиагнозы
    INNER JOIN Приемы ON Приемы.КодПриема = ПоставленныеДиагнозы.КодПриема
    INNER JOIN Пациенты ON Пациенты.КодПациента = Приемы.КодПациента
    WHERE Пациенты.ФИО = 'Иванов Иван Иванович'
);




SELECT *
FROM Пациенты
WHERE Пациенты.ФИО != 'Иванов Иван Иванович'
AND Пациенты.КодПациента NOT IN (
	SELECT Пациенты.КодПациента
	FROM Пациенты
	INNER JOIN Приемы ON Приемы.КодПациента = Пациенты.КодПациента
	INNER JOIN ПоставленныеДиагнозы ON ПоставленныеДиагнозы.КодПриема = Приемы.КодПриема
	WHERE ПоставленныеДиагнозы.КодДиагноза NOT IN (
		SELECT ПоставленныеДиагнозы.КодДиагноза
		FROM ПоставленныеДиагнозы
		INNER JOIN Приемы ON Приемы.КодПриема = ПоставленныеДиагнозы.КодПриема
		INNER JOIN Пациенты ON Пациенты.КодПациента = Приемы.КодПациента
		WHERE Пациенты.ФИО = 'Иванов Иван Иванович'
	)
);
