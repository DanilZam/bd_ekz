CREATE TABLE Законодатель (
    КодЗаконодателя INT PRIMARY KEY IDENTITY(1,1),
    ФИО VARCHAR(100) NOT NULL,
	Адрес VARCHAR(100) NOT NULL,
	ДомТел VARCHAR(13) NOT NULL,
	СлужебТел VARCHAR(13) NOT NULL,
);

CREATE TABLE Профили (
    КодПрофиля INT PRIMARY KEY IDENTITY(1,1),
    НаименованиеПрофиля VARCHAR(100) DEFAULT('Неизвестный профиль') NOT NULL
);

CREATE TABLE МестаПроведения (
    КодМеста INT PRIMARY KEY IDENTITY(1,1),
    НаименованиеМеста VARCHAR(100) NOT NULL
);

CREATE TABLE Комиссии (
    КодКомиссии INT PRIMARY KEY IDENTITY(1,1),
    НаименованиеКомиссии VARCHAR(100) NOT NULL,
    КодПредседателя INT NOT NULL,
    КодПрофиля INT NOT NULL ,
    CONSTRAINT FK_Комиссии_Законодат FOREIGN KEY(КодПредседателя) REFERENCES Законодатель(КодЗаконодателя),
    CONSTRAINT FK_Комиссии_Проф FOREIGN KEY(КодПрофиля) REFERENCES Профили(КодПрофиля)
);

CREATE TABLE СписокЧленовКомиссии (
    КодЧленаКомис INT PRIMARY KEY IDENTITY(1,1),
    КодЗаконодателя INT NOT NULL,
    КодКомиссии INT NOT NULL ,
    CONSTRAINT FK_СписЧлКомис_Законодат FOREIGN KEY(КодЗаконодателя) REFERENCES Законодатель(КодЗаконодателя),
    CONSTRAINT FK_СписЧлКомис_Комиссии FOREIGN KEY(КодКомиссии) REFERENCES Комиссии(КодКомиссии)
);

CREATE TABLE Заседания (
    КодЗаседания INT PRIMARY KEY IDENTITY(1,1),
    КодМеста INT NOT NULL,
    КодКомиссии INT NOT NULL,
	ВремяНачала DATETIME NOT NULL,
	ВремяКонца DATETIME NOT NULL,
	НаименованиеПовестки VARCHAR(100) NOT NULL,
    CONSTRAINT FK_Заседания_МестаПров FOREIGN KEY(КодМеста) REFERENCES МестаПроведения(КодМеста),
    CONSTRAINT FK_Заседания_Комиссии FOREIGN KEY(КодКомиссии) REFERENCES Комиссии(КодКомиссии),
	CONSTRAINT CK_ВремяНач_ВремяКон CHECK (ВремяНачала < ВремяКонца)
);


INSERT INTO Законодатель (ФИО, Адрес, ДомТел, СлужебТел) VALUES 
('Иванов Иван Иванович', 'ул. Ленина, д. 1', '89001234567', '84951234567'),
('Петров Петр Петрович', 'ул. Гагарина, д. 2', '89007654321', '84957654321'),
('Сидоров Сидор Сидорович', 'ул. Чехова, д. 3', '89006543210', '84956543210'),
('Кузнецова Анна Викторовна', 'ул. Пушкина, д. 4', '89002345678', '84952345678'),
('Васильева Ольга Николаевна', 'ул. Тургенева, д. 5', '89003456789', '84953456789'),
('Морозов Алексей Дмитриевич', 'ул. Толстого, д. 6', '89004567890', '84954567890'),
('Зайцев Николай Петрович', 'ул. Крылова, д. 7', '89005678901', '84955678901'),
('Смирнова Елена Сергеевна', 'ул. Достоевского, д. 8', '89006789012', '84956789012');

-- Заполнение таблицы Профили
INSERT INTO Профили (НаименованиеПрофиля) VALUES 
('Финансовый'),
('Юридический'),
('Технический');

-- Заполнение таблицы МестаПроведения
INSERT INTO МестаПроведения (НаименованиеМеста) VALUES 
('Зал заседаний 1'),
('Зал заседаний 2'),
('Зал заседаний 3');

-- Заполнение таблицы Комиссии
INSERT INTO Комиссии (НаименованиеКомиссии, КодПредседателя, КодПрофиля) VALUES 
('Комиссия по финансам', 1, 1),
('Комиссия по правовым вопросам', 4, 2),
('Комиссия по технике', 6, 3);

-- Заполнение таблицы СписокЧленовКомиссии
INSERT INTO СписокЧленовКомиссии (КодЗаконодателя, КодКомиссии) VALUES 
(2, 1),
(3, 1),
(5, 1),
(7, 1),
(8, 1),
(1, 2),
(3, 2),
(5, 2),
(7, 2),
(2, 3),
(4, 3),
(5, 3),
(7, 3),
(8, 3);

-- Заполнение таблицы Заседания
INSERT INTO Заседания (КодМеста, КодКомиссии, ВремяНачала, ВремяКонца, НаименованиеПовестки) VALUES 
(1, 1, '2024-06-01 10:00', '2024-06-01 12:00', 'Бюджет 2024'),
(2, 2, '2024-06-02 14:00', '2024-06-02 16:00', 'Юридические вопросы'),
(3, 3, '2024-06-03 09:00', '2024-06-03 11:00', 'Технические новшества');


Задание 1

Задание 2

CREATE PROCEDURE ПолучитьКомиссииСПо
AS
BEGIN
    SELECT КодКомиссии, НаименованиеКомиссии, КодПредседателя, КодПрофиля
    FROM Комиссии
    WHERE НаименованиеКомиссии LIKE '%п\_о%' ESCAPE '\';
END;


EXEC ПолучитьКомиссииСПо


Задание 3

CREATE PROCEDURE ПолучитьЗаконодателяПоИД
    @КодЗаконодателя INT,
    @ФИО VARCHAR(100) OUTPUT,
    @ДомТел VARCHAR(13) OUTPUT,
    @СлужебТел VARCHAR(13) OUTPUT
AS
BEGIN
    SELECT
        @ФИО = ФИО,
        @ДомТел = ДомТел,
        @СлужебТел = СлужебТел
    FROM
        Законодатель
    WHERE
        КодЗаконодателя = @КодЗаконодателя;
END;




DECLARE
    @КодЗаконодателя INT = 1,
    @ФИО VARCHAR(100),
    @ДомТел VARCHAR(13),
    @СлужебТел VARCHAR(13);


EXEC ПолучитьЗаконодателяПоИД @КодЗаконодателя, @ФИО OUTPUT, @ДомТел OUTPUT, @СлужебТел OUTPUT;


SELECT @ФИО AS ФИО, @ДомТел AS ДомТел, @СлужебТел AS СлужебТел;


Задание 4

CREATE OR ALTER TRIGGER TR_УдалитьСведенияЗаконодателя
ON Законодатель
FOR DELETE
AS
BEGIN
	DELETE FROM СписокЧленовКомиссии
    WHERE КодКомиссии IS NULL;

	DELETE FROM Заседания
    WHERE КодКомиссии IN (SELECT КодКомиссии FROM Комиссии WHERE КодПредседателя IN (SELECT КодЗаконодателя FROM DELETED))

    DELETE FROM Комиссии
    WHERE КодПредседателя IN (SELECT КодЗаконодателя FROM DELETED);

	DELETE FROM СписокЧленовКомиссии
    WHERE КодЗаконодателя IN (SELECT КодЗаконодателя FROM DELETED);
END;


SELECT * FROM Законодатель
SELECT * FROM СписокЧленовКомиссии
SELECT * FROM Комиссии
SELECT * FROM Заседания

DELETE FROM Законодатель WHERE КодЗаконодателя = 4

SELECT * FROM Законодатель
SELECT * FROM СписокЧленовКомиссии
SELECT * FROM Комиссии
SELECT * FROM Заседания

CREATE OR ALTER TRIGGER TR_УдалитьЗаконодателя
ON Законодатель
INSTEAD OF DELETE
AS
BEGIN
    DECLARE @КодЗаконодателя INT;


    SELECT @КодЗаконодателя = КодЗаконодателя FROM deleted;


    DELETE FROM СписокЧленовКомиссии
    WHERE КодКомиссии IN (SELECT КодКомиссии FROM Комиссии WHERE КодПредседателя = @КодЗаконодателя);


    DELETE FROM Заседания
    WHERE КодКомиссии IN (SELECT КодКомиссии FROM Комиссии WHERE КодПредседателя = @КодЗаконодателя);


    DELETE FROM Комиссии WHERE КодПредседателя = @КодЗаконодателя;


    DELETE FROM СписокЧленовКомиссии WHERE КодЗаконодателя = @КодЗаконодателя;


    DELETE FROM Законодатель WHERE КодЗаконодателя = @КодЗаконодателя;
END;


SELECT * FROM Законодатель
SELECT * FROM СписокЧленовКомиссии
SELECT * FROM Комиссии
SELECT * FROM Заседания


DELETE FROM Законодатель WHERE КодЗаконодателя = 4


SELECT * FROM Законодатель
SELECT * FROM СписокЧленовКомиссии
SELECT * FROM Комиссии
SELECT * FROM Заседания


Задание 5

CREATE VIEW V_ЗаседанияКомиссий AS
SELECT
    Заседания.КодЗаседания,
    Заседания.КодКомиссии,
    Комиссии.НаименованиеКомиссии,
    Заседания.ВремяНачала,
    Заседания.ВремяКонца,
    DATEDIFF(MINUTE, Заседания.ВремяНачала, Заседания.ВремяКонца) AS ДлительностьВМинутах,
    Заседания.НаименованиеПовестки
FROM
    Заседания
JOIN
    Комиссии ON Заседания.КодКомиссии = Комиссии.КодКомиссии
ORDER BY
    Комиссии.НаименованиеКомиссии DESC
OFFSET 0 ROWS;

Задание 6

SELECT
    Законодатель.ФИО,
    COUNT(DISTINCT СписокЧленовКомиссии.КодКомиссии) AS ЧислоКомиссий,
    COUNT(DISTINCT Заседания.КодЗаседания) AS ЧислоЗаседаний
FROM
    Законодатель
LEFT JOIN
    СписокЧленовКомиссии ON  СписокЧленовКомиссии.КодЗаконодателя = Законодатель.КодЗаконодателя
LEFT JOIN
    Комиссии ON Комиссии.КодКомиссии = СписокЧленовКомиссии.КодКомиссии
LEFT JOIN
    Заседания ON Заседания.КодКомиссии = Комиссии.КодКомиссии
GROUP BY
    Законодатель.КодЗаконодателя, Законодатель.ФИО
ORDER BY
    Законодатель.ФИО DESC, COUNT(DISTINCT СписокЧленовКомиссии.КодКомиссии) DESC, COUNT(DISTINCT Заседания.КодЗаседания) DESC;

Задание 7

SELECT DISTINCT ИскомыеЗаконодатели.*
FROM Законодатель AS ИскомыеЗаконодатели
INNER JOIN СписокЧленовКомиссии ON СписокЧленовКомиссии.КодЗаконодателя = ИскомыеЗаконодатели.КодЗаконодателя
INNER JOIN Заседания ON Заседания.КодКомиссии = СписокЧленовКомиссии.КодКомиссии
WHERE
Заседания.КодЗаседания IN (
    SELECT Заседания.КодЗаседания
    FROM Законодатель AS ЗаданныйЗаконодатель
    INNER JOIN СписокЧленовКомиссии ON СписокЧленовКомиссии.КодЗаконодателя = ИскомыеЗаконодатели.КодЗаконодателя
    INNER JOIN Заседания ON Заседания.КодКомиссии = СписокЧленовКомиссии.КодКомиссии
    WHERE ЗаданныйЗаконодатель.КодЗаконодателя = 1
)
AND
ИскомыеЗаконодатели.КодЗаконодателя != 1
GROUP BY ИскомыеЗаконодатели.КодЗаконодателя, ИскомыеЗаконодатели.ФИО, ИскомыеЗаконодатели.Адрес, ИскомыеЗаконодатели.ДомТел, ИскомыеЗаконодатели.СлужебТел
HAVING COUNT(DISTINCT Заседания.КодЗаседания) = (
    SELECT COUNT(DISTINCT Заседания.КодЗаседания)
    FROM Законодатель AS ЗаданныйЗаконодатель
    INNER JOIN СписокЧленовКомиссии ON СписокЧленовКомиссии.КодЗаконодателя = ИскомыеЗаконодатели.КодЗаконодателя
    INNER JOIN Заседания ON Заседания.КодКомиссии = СписокЧленовКомиссии.КодКомиссии
    WHERE ЗаданныйЗаконодатель.КодЗаконодателя = 1
);




Двойное отрицание:
SELECT DISTINCT ИскомыеЗаконодатели.*
FROM Законодатель AS ИскомыеЗаконодатели
WHERE ИскомыеЗаконодатели.КодЗаконодателя != 1
AND ИскомыеЗаконодатели.КодЗаконодателя NOT IN (
    SELECT СписокЧленовКомиссии.КодЗаконодателя
    FROM Заседания
    INNER JOIN СписокЧленовКомиссии ON СписокЧленовКомиссии.КодКомиссии = Заседания.КодКомиссии
    WHERE Заседания.КодЗаседания NOT IN (
        SELECT Заседания.КодЗаседания
        FROM Заседания
        INNER JOIN СписокЧленовКомиссии ON СписокЧленовКомиссии.КодКомиссии = Заседания.КодКомиссии
        WHERE СписокЧленовКомиссии.КодЗаконодателя = 1
    )
);
