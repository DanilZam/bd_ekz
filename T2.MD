CREATE TABLE ЕдиницыИзмерения (
    КодЕдИзм INT PRIMARY KEY IDENTITY(1,1),
    НазваниеЕдИзм VARCHAR(100) NOT NULL,
    СокращениеЕдИзм VARCHAR(10) NOT NULL
);


CREATE TABLE АптекариКассиры (
    КодАптекаря INT PRIMARY KEY IDENTITY(1,1),
    ФИО VARCHAR(120) NOT NULL,
Телефон VARCHAR(13) NOT NULL,
КодКатегории INT NOT NULL,
CONSTRAINT FK_АптКас_КатАпт FOREIGN KEY (КодКатегории) REFERENCES КатегорииАптекаря(КодКатегории)
);


CREATE TABLE Лекарства (
    КодЛекарства INT PRIMARY KEY IDENTITY(1,1),
    НазваниеЛекарства VARCHAR(120) NOT NULL,
    ДатаВыпуска DATE NOT NULL,
    СрокГодности INT NOT NULL,
    КодЕдИзм INT NOT NULL,
    Производитель VARCHAR(13) NOT NULL,
    CONSTRAINT FK_Лек_ЕдИзм FOREIGN KEY(КодЕдИзм) REFERENCES ЕдиницыИзмерения(КодЕдИзм)
);


CREATE TABLE АналогиЛекарств (
    КодЛекарства INT NOT NULL,
    КодАналогаЛекарства INT NOT NULL,
    CONSTRAINT FK_Лек_Лек FOREIGN KEY(КодЛекарства) REFERENCES Лекарства(КодЛекарства),
    CONSTRAINT FK_АнЛек_Лек FOREIGN KEY(КодАналогаЛекарства) REFERENCES Лекарства(КодЛекарства)
);


CREATE TABLE ПродажаЛекарств (
    КодПродажи INT PRIMARY KEY IDENTITY(1,1),
    ДатаПродажи DATE NOT NULL,
    КодАптекаря INT NOT NULL,
    CONSTRAINT FK_ПродЛек_Аптекарь FOREIGN KEY(КодАптекаря) REFERENCES АптекариКассиры(КодАптекаря)
);


CREATE TABLE ТЧ_Продажи (
    КодТЧ INT PRIMARY KEY IDENTITY(1,1),
    КодПродажи INT NOT NULL,
    КодЛекарства INT NOT NULL,
    Количество INT CHECK(Количество > 0) NOT NULL ,
    ЦенаЕд FLOAT NOT NULL,
    CONSTRAINT FK_ТЧПродаж_Леква FOREIGN KEY(КодЛекарства) REFERENCES Лекарства(КодЛекарства),
    CONSTRAINT FK_ТЧПродаж_Продаж FOREIGN KEY(КодПродажи) REFERENCES ПродажаЛекарств(КодПродажи)
);


CREATE TABLE ПартияЛекарств (
    КодПартии INT  PRIMARY KEY IDENTITY(1,1),
    ДатаПартии DATE NOT NULL,
    НаимДокПост VARCHAR(100) DEFAULT('Приходный ордер') NOT NULL
);


CREATE TABLE ТЧ_ПартииЛек (
    КодТЧ INT  PRIMARY KEY IDENTITY(1,1),
    КодПартии INT NOT NULL,
    КодЛекарства INT NOT NULL,
    Количество INT CHECK(Количество > 0) NOT NULL ,
    ЦенаЕд FLOAT NOT NULL,
    CONSTRAINT FK_ТЧПартии_Леква FOREIGN KEY(КодЛекарства) REFERENCES Лекарства(КодЛекарства),
    CONSTRAINT FK_ТЧПартии_Партия FOREIGN KEY(КодПартии) REFERENCES ПартияЛекарств(КодПартии)
);


CREATE TABLE КатегорииАптекаря (
    КодКатегории INT PRIMARY KEY IDENTITY(1,1),
    НаименованиеКатегории VARCHAR(30) NOT NULL
);




-- Вставка данных в таблицу ЕдиницыИзмерения
INSERT INTO ЕдиницыИзмерения (НазваниеЕдИзм, СокращениеЕдИзм) VALUES
('Миллилитры', 'мл'),
('Граммы', 'г'),
('Таблетки', 'таб'),
('Капсулы', 'кап'),
('Ампулы', 'амп');


INSERT INTO КатегорииАптекаря (НаименованиеКатегории) VALUES
('Старший кассир'),
('Младший кассир');


-- Вставка данных в таблицу АптекариКассиры
INSERT INTO АптекариКассиры (ФИО, Телефон, КодКатегории) VALUES
('Иванов Иван Иванович', '89991234567', 1),
('Петров Петр Петрович', '89997654321', 1),
('Сидорова Мария Павловна', '89993456789', 2);


-- Вставка данных в таблицу Лекарства
INSERT INTO Лекарства (НазваниеЛекарства, ДатаВыпуска, СрокГодности, КодЕдИзм, Производитель) VALUES
('Парацетамол', '2023-01-15', 24, 3, 'ПФК-1'),
('Ибупрофен', '2022-12-10', 36, 3, 'ПФК-2'),
('Амоксициллин', '2023-03-05', 24, 4, 'ПФК-3'),
('Лоратадин', '2023-02-20', 36, 4, 'ПФК-1'),
('Цефтриаксон', '2023-01-25', 48, 5, 'ПФК-2');


-- Вставка данных в таблицу АналогиЛекарств
INSERT INTO АналогиЛекарств (КодЛекарства, КодАналогаЛекарства) VALUES
(1, 2), -- Парацетамол и Ибупрофен
(3, 4), -- Амоксициллин и Лоратадин
(4, 2);


-- Вставка данных в таблицу ПродажаЛекарств
INSERT INTO ПродажаЛекарств (ДатаПродажи, КодАптекаря) VALUES
('2024-01-15', 1),
('2024-02-20', 2),
('2024-03-10', 3);


-- Вставка данных в таблицу ТЧ_Продажи
INSERT INTO ТЧ_Продажи (КодПродажи, КодЛекарства, Количество, ЦенаЕд) VALUES
(1, 1, 10, 50.0),
(1, 3, 5, 150.0),
(2, 2, 7, 70.0),
(3, 4, 20, 200.0),
(3, 5, 15, 250.0);


-- Вставка данных в таблицу ПартияЛекарств
INSERT INTO ПартияЛекарств (ДатаПартии, НаимДокПост) VALUES
('2023-01-01', 'Приходный ордер 001'),
('2023-02-15', 'Приходный ордер 002'),
('2023-03-10', 'Приходный ордер 003');


-- Вставка данных в таблицу ТЧ_ПартииЛек
INSERT INTO ТЧ_ПартииЛек (КодПартии, КодЛекарства, Количество, ЦенаЕд) VALUES
(1, 1, 100, 45.0),
(1, 2, 200, 65.0),
(2, 3, 150, 140.0),
(2, 4, 300, 190.0),
(3, 5, 250, 230.0);







Задание 1

Задание 2

CREATE PROCEDURE ЛекарстваПоКонцентрации
    @Concentration VARCHAR(3)
AS
BEGIN
    SELECT *
    FROM
        Лекарства
    WHERE
        НазваниеЛекарства LIKE '%концентрация ' + @Concentration + '\%%' ESCAPE '\';
END;


Задание 3

CREATE PROCEDURE ИнфоАптекаря
    @PharmacistID INT,
    @ФИО VARCHAR(120) OUTPUT,
    @Категория VARCHAR(30) OUTPUT
AS
BEGIN
    SELECT @ФИО = a.ФИО, @Категория = k.НаименованиеКатегории
    FROM АптекариКассиры a
    JOIN КатегорииАптекаря k ON a.КодКатегории = k.КодКатегории
    WHERE a.КодАптекаря = @PharmacistID;
END;




DECLARE @ФИО VARCHAR(120);
DECLARE @Категория VARCHAR(30);


EXEC ИнфоАптекаря 1,
    @ФИО = @ФИО OUTPUT,
    @Категория = @Категория OUTPUT;


SELECT @ФИО AS ФИО, @Категория AS Категория;


Задание 4

CREATE TRIGGER ТриггерУдаленияАптекаря
ON АптекариКассиры
INSTEAD OF DELETE
AS
BEGIN
DECLARE @КодАптекаря INT;
    SELECT @КодАптекаря = КодАптекаря FROM deleted


    DELETE FROM ТЧ_Продажи
    WHERE КодПродажи IN (SELECT КодПродажи FROM ПродажаЛекарств WHERE КодАптекаря = @КодАптекаря);


    DELETE FROM ПродажаЛекарств
    WHERE КодАптекаря = @КодАптекаря;


END




SELECT * FROM АптекариКассиры
SELECT * FROM ПродажаЛекарств
SELECT * FROM ТЧ_Продажи


DELETE FROM АптекариКассиры WHERE КодАптекаря = 1


SELECT * FROM АптекариКассиры
SELECT * FROM ПродажаЛекарств
SELECT * FROM ТЧ_Продажи

Задание 5

CREATE VIEW ЛекарстваСАналогами AS
SELECT
    Лекарства.КодЛекарства,
    Лекарства.НазваниеЛекарства,
    Лекарства.ДатаВыпуска,
    Лекарства.СрокГодности,
    Лекарства.КодЕдИзм,
    Лекарства.Производитель,
    АналогиЛекарств.КодАналогаЛекарства,
    Аналоги.НазваниеЛекарства AS НазваниеАналога
FROM
    Лекарства
LEFT JOIN
    АналогиЛекарств ON Лекарства.КодЛекарства = АналогиЛекарств.КодЛекарства
LEFT JOIN
    Лекарства AS Аналоги ON АналогиЛекарств.КодАналогаЛекарства = Аналоги.КодЛекарства
ORDER BY
    Лекарства.НазваниеЛекарства DESC;
OFFSET 0 ROWS;



Задание 6

SELECT
    Лекарства.КодЛекарства,
    Лекарства.НазваниеЛекарства,
    COUNT(ТЧ_Продажи.КодЛекарства) AS ЧислоПриобретений
FROM
    Лекарства
JOIN
    ТЧ_Продажи ON Лекарства.КодЛекарства = ТЧ_Продажи.КодЛекарства
GROUP BY
    Лекарства.КодЛекарства,
    Лекарства.НазваниеЛекарства
ORDER BY
    ЧислоПриобретений DESC;

Задание 7

SELECT DISTINCT Лекарства.КодЛекарства, Лекарства.НазваниеЛекарства, Лекарства.ДатаВыпуска, Лекарства.СрокГодности, Лекарства.Производитель, ЕдиницыИзмерения.НазваниеЕдИзм
FROM Лекарства
INNER JOIN ЕдиницыИзмерения ON ЕдиницыИзмерения.КодЕдИзм = Лекарства.КодЕдИзм
INNER JOIN АналогиЛекарств ON АналогиЛекарств.КодЛекарства = Лекарства.КодЛекарства
WHERE
АналогиЛекарств.КодАналогаЛекарства IN (
    SELECT АналогиЛекарств.КодАналогаЛекарства
    FROM АналогиЛекарств
    WHERE АналогиЛекарств.КодЛекарства = 1
)
AND
Лекарства.КодЛекарства != 1
GROUP BY Лекарства.КодЛекарства, Лекарства.НазваниеЛекарства, Лекарства.ДатаВыпуска, Лекарства.СрокГодности, Лекарства.Производитель, Лекарства.КодЕдИзм, ЕдиницыИзмерения.НазваниеЕдИзм
HAVING COUNT(DISTINCT АналогиЛекарств.КодАналогаЛекарства) = (
    SELECT COUNT(DISTINCT АналогиЛекарств.КодАналогаЛекарства)
    FROM АналогиЛекарств
    WHERE АналогиЛекарств.КодЛекарства = 1
);


SELECT Лекарства.КодЛекарства, Лекарства.НазваниеЛекарства, Лекарства.ДатаВыпуска, Лекарства.СрокГодности, Лекарства.Производитель, ЕдиницыИзмерения.НазваниеЕдИзм
FROM Лекарства
INNER JOIN ЕдиницыИзмерения ON ЕдиницыИзмерения.КодЕдИзм = Лекарства.КодЕдИзм
INNER JOIN АналогиЛекарств ON АналогиЛекарств.КодЛекарства = Лекарства.КодЛекарства
WHERE Лекарства.КодЛекарства != 1
AND АналогиЛекарств.КодЛекарства NOT IN (
	SELECT АЛ1.КодЛекарства
	FROM АналогиЛекарств АЛ1
	WHERE АЛ1.КодАналогаЛекарства NOT IN (
		SELECT АЛ2.КодАналогаЛекарства
		FROM АналогиЛекарств АЛ2
		WHERE АЛ2.КодЛекарства = 1
	)
);
